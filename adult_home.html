<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Home - MyMULA</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0d7ff2",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
            font-size: 24px;
        }

        body {
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .dark .glass-card {
            background: rgba(16, 25, 34, 0.9);
        }

        .gradient-header {
            background: linear-gradient(135deg, #0d7ff2 0%, #00d4ff 100%);
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <!-- Top App Bar -->
        <div class="sticky top-0 z-10 gradient-header px-6 py-6 rounded-b-[2rem] shadow-lg">
            <div class="flex items-center justify-between text-white mb-2">
                <div class="flex items-center gap-4">
                    <div
                        class="size-14 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white text-2xl font-bold border-2 border-white/30">
                        S
                    </div>
                    <div>
                        <h1 class="text-white text-2xl font-bold leading-tight">
                            Hi, Sarah!
                        </h1>
                        <p class="text-white/80 text-sm font-medium">Have a great day!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 px-5 py-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <!-- Linked Child Card -->
                <div class="glass-card rounded-3xl p-5 shadow-sm border border-white/50 dark:border-gray-800 animate-slide-up"
                    style="animation-delay: 0.1s">
                    <div
                        class="size-12 rounded-2xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mb-4 text-primary">
                        <span class="material-symbols-outlined text-3xl">face</span>
                    </div>
                    <div class="text-3xl font-bold text-[#111418] dark:text-white mb-1">
                        1
                    </div>
                    <div class="text-sm font-medium text-[#60758a] dark:text-gray-400">
                        Linked<br />Child
                    </div>
                </div>

                <!-- Pending Requests Card -->
                <div class="glass-card rounded-3xl p-5 shadow-sm border border-white/50 dark:border-gray-800 animate-slide-up"
                    style="animation-delay: 0.2s">
                    <div
                        class="size-12 rounded-2xl bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center mb-4 text-orange-500">
                        <span class="material-symbols-outlined text-3xl">folder_shared</span>
                    </div>
                    <div id="pendingCount" class="text-3xl font-bold text-[#111418] dark:text-white mb-1">
                        0
                    </div>
                    <div class="text-sm font-medium text-[#60758a] dark:text-gray-400">
                        Pending<br />Requests
                    </div>
                </div>
            </div>

            <!-- Linked Children Section -->
            <div class="mb-8 animate-slide-up" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h2 class="text-[#111418] dark:text-white text-lg font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">people</span>
                        Linked Children
                    </h2>
                </div>

                <!-- Children Cards Container -->
                <div id="linkedChildrenContainer" class="space-y-3">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>

            <!-- Recent Activity Section -->
            <div class="animate-slide-up pb-24" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h2 class="text-[#111418] dark:text-white text-lg font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">history</span>
                        Recent Activity
                    </h2>
                    <a href="adult_requests.html" class="text-primary text-sm font-semibold hover:underline">View
                        All</a>
                </div>

                <!-- Activity List Container -->
                <div id="recentActivityList" class="flex flex-col gap-3">
                    <!-- Dynamic content will be loaded here -->
                    <div class="text-center py-8 text-gray-400">
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="sticky bottom-0 bg-white dark:bg-background-dark border-t border-[#f0f2f5] dark:border-gray-700">
            <div class="flex h-[72px] justify-around px-4 pb-3 pt-2">
                <a class="flex flex-1 flex-col items-center justify-end gap-1 text-primary" href="adult_home.html">
                    <div class="flex h-8 items-center justify-center">
                        <span class="material-symbols-outlined notranslate fill">home</span>
                    </div>
                    <p class="text-primary text-xs font-semibold">Home</p>
                </a>

                <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#6c757d] dark:text-gray-400 hover:text-primary transition-colors"
                    href="adult_requests.html">
                    <div class="flex h-8 items-center justify-center relative">
                        <span class="material-symbols-outlined notranslate">pending_actions</span>
                        <div id="navPendingBadge"
                            class="hidden absolute -top-1 -right-3 size-4 bg-red-500 rounded-full flex items-center justify-center border-2 border-white dark:border-background-dark">
                            <span id="navPendingCount" class="text-white text-[9px] font-bold">0</span>
                        </div>
                    </div>
                    <p class="text-xs font-semibold">Requests</p>
                </a>

                <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#6c757d] dark:text-gray-400 hover:text-primary transition-colors"
                    href="adult_profile.html">
                    <div class="flex h-8 items-center justify-center">
                        <span class="material-symbols-outlined notranslate">account_circle</span>
                    </div>
                    <p class="text-xs font-semibold">Profile</p>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Government data
        let governmentData = null;

        document.addEventListener("DOMContentLoaded", () => {
            // Load government data first
            fetch('mock_profile_data.json')
                .then(res => res.json())
                .then(data => {
                    governmentData = data.government_data;
                    initDashboard();
                    // Poll for real-time updates every 2 seconds
                    setInterval(updatePendingCount, 2000);
                })
                .catch(err => {
                    console.error('Failed to load government data:', err);
                    initDashboard();
                });
        });

        function initDashboard() {
            // Load requests from Storage (localStorage first for cross-tab persistence)
            let requests = JSON.parse(
                localStorage.getItem("child_requests") || sessionStorage.getItem("child_requests") || "[]"
            );

            // Update Counts - only count pending requests
            const pendingCount = requests.filter(
                (r) => r.status === "pending"
            ).length;

            // 1. Stats Card
            document.getElementById("pendingCount").textContent = pendingCount;

            // 2. Nav Badge
            const badge = document.getElementById("navPendingBadge");
            const badgeCount = document.getElementById("navPendingCount");
            if (pendingCount > 0) {
                badge.classList.remove("hidden");
                badgeCount.textContent = pendingCount > 9 ? "9+" : pendingCount;
            } else {
                badge.classList.add("hidden");
            }

            // 3. Load Linked Children
            loadLinkedChildren();

            // 4. Recent Activity
            updateRecentActivity(requests);
        }

        function updatePendingCount() {
            // Read from localStorage first for cross-tab persistence
            const requests = JSON.parse(
                localStorage.getItem("child_requests") || sessionStorage.getItem("child_requests") || "[]"
            );

            // Update Counts - only count pending requests
            const pendingCount = requests.filter(
                (r) => r.status === "pending"
            ).length;

            // 1. Stats Card
            document.getElementById("pendingCount").textContent = pendingCount;

            // 2. Nav Badge
            const badge = document.getElementById("navPendingBadge");
            const badgeCount = document.getElementById("navPendingCount");
            if (pendingCount > 0) {
                badge.classList.remove("hidden");
                badgeCount.textContent = pendingCount > 9 ? "9+" : pendingCount;
            } else {
                badge.classList.add("hidden");
            }

            // 3. Update Recent Activity
            updateRecentActivity(requests);
        }

        function loadLinkedChildren() {
            const container = document.getElementById("linkedChildrenContainer");
            const adultIC = sessionStorage.getItem('adult_ic') || '850612-10-5234';

            // Get children linked to this adult from government data
            const adultData = governmentData?.adults?.find(a => a.ic === adultIC);
            const childrenICs = adultData?.children_ic || ['071215-14-1234'];

            // Get children details
            const linkedChildren = childrenICs.map(icNum => {
                return governmentData?.children?.find(c => c.ic === icNum);
            }).filter(Boolean);

            if (linkedChildren.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400 bg-white/50 dark:bg-gray-800/50 rounded-3xl border border-white/50 dark:border-gray-800">
                        <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">person_off</span>
                        <p class="text-sm">No linked children</p>
                    </div>
                `;
                return;
            }

            // Check if junior is registered to determine status
            const juniorRegistered = sessionStorage.getItem('junior_registered') === 'true';

            container.innerHTML = linkedChildren.map(child => {
                const isVerified = juniorRegistered;
                const statusColor = isVerified ? 'text-green-600' : 'text-orange-500';
                const statusIcon = isVerified ? 'verified' : 'pending';
                const statusText = isVerified ? 'Account Linked' : 'Pending Registration';

                // Calculate age from IC (first 6 digits are YYMMDD)
                const icParts = child.ic.split('-');
                const birthYear = parseInt('20' + icParts[0].substring(0, 2));
                const currentYear = new Date().getFullYear();
                const age = currentYear - birthYear;

                return `
                    <div onclick="window.location.href='Linked_children.html'"
                        class="glass-card rounded-3xl p-5 shadow-sm border border-white/50 dark:border-gray-800 flex items-center gap-4 hover:shadow-md transition-all cursor-pointer">
                        <div class="size-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-3xl">face</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-[#111418] dark:text-white text-lg font-bold">
                                    ${child.name.split(' ')[0]}
                                </h3>
                                <span
                                    class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-primary text-[10px] font-bold uppercase tracking-wider rounded-full">Junior</span>
                            </div>
                            <p class="text-[#60758a] dark:text-gray-400 text-sm mb-2">
                                Age ${age}
                            </p>
                            <div class="flex items-center gap-1.5 ${statusColor}">
                                <span class="material-symbols-outlined text-[18px] ${isVerified ? 'fill' : ''}">${statusIcon}</span>
                                <span class="text-xs font-semibold">${statusText}</span>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                    </div>
                `;
            }).join('');

            // Update stats card with linked children count
            const linkedCountEl = document.querySelector('.text-3xl.font-bold');
            if (linkedCountEl) {
                linkedCountEl.textContent = linkedChildren.length;
            }
        }

        function updateRecentActivity(requests) {
            const container = document.getElementById("recentActivityList");

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400 bg-white/50 dark:bg-gray-800/50 rounded-3xl border border-white/50 dark:border-gray-800">
                        <span class="material-symbols-outlined text-4xl mb-2 text-gray-300">history</span>
                        <p class="text-sm">No recent activity</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp desc (latest first) - handle both ISO strings and timestamps
            const sortedRequests = requests.sort((a, b) => {
                const timeA = new Date(a.timestamp || a.approvedAt || 0).getTime();
                const timeB = new Date(b.timestamp || b.approvedAt || 0).getTime();
                return timeB - timeA;
            });

            container.innerHTML = sortedRequests
                .map(
                    (req) => `
                <div onclick="handleActivityClick('${req.id}', '${req.type}', '${req.status}')" class="glass-card rounded-3xl p-4 shadow-sm border border-white/50 dark:border-gray-800 flex items-center gap-4 cursor-pointer hover:shadow-md transition-all group">
                    <div class="size-12 rounded-2xl ${getTypeColor(
                        req.type
                    )} flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined ${getTypeTextColor(
                        req.type
                    )}">${getTypeIcon(req.type)}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-[#111418] dark:text-white font-semibold mb-1 truncate text-sm sm:text-base">
                            ${req.title}
                        </h3>
                        <p class="text-[#60758a] dark:text-gray-400 text-xs sm:text-sm">From: ${req.childName
                        } â€¢ ${getRelativeTime(req.timestamp || req.approvedAt)}</p>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <div class="px-2.5 py-1 ${getStatusColor(
                            req.status
                        )} rounded-full">
                            <span class="${getStatusTextColor(
                            req.status
                        )} text-xs font-bold uppercase tracking-wide">${req.status
                        }</span>
                        </div>
                        <button class="text-gray-400 dark:text-gray-500 group-hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                </div>
            `
                )
                .join("");
        }

        function handleActivityClick(requestId, type, status) {
            sessionStorage.setItem('current_approval_request', requestId);

            if (status === 'approved') {
                // Navigate to view pages for approved requests
                const viewPages = {
                    scholarship: 'scholarship_view_document.html',
                    sme: 'SME_view_document.html',
                    dental: 'Dental_Progress_Tracker.html',
                    transaction: 'Age_Approval_Details.html'
                };
                const targetPage = viewPages[type] || 'adult_requests.html';
                window.location.href = `${targetPage}?source=adult_home`;
            } else {
                // Navigate to approval pages for pending requests
                const approvalPages = {
                    scholarship: 'request_received_guardian.html',
                    sme: 'SME_Guardian_Approval.html',
                    dental: 'request_received_guardian.html',
                    transaction: 'Transaction_guardian_approval.html'
                };
                const targetPage = approvalPages[type] || 'adult_requests.html';
                window.location.href = `${targetPage}?source=adult_home`;
            }
        }

        // Helper functions
        function getTypeIcon(type) {
            const icons = {
                scholarship: "school",
                sme: "business_center",
                dental: "dentistry",
                age_verification: "verified_user",
                transaction: "stadia_controller",
            };
            return icons[type] || "description";
        }

        function getTypeColor(type) {
            const colors = {
                scholarship: "bg-blue-50 dark:bg-blue-900/20",
                sme: "bg-green-50 dark:bg-green-900/20",
                dental: "bg-purple-50 dark:bg-purple-900/20",
                age_verification: "bg-orange-50 dark:bg-orange-900/20",
                transaction: "bg-pink-50 dark:bg-pink-900/20",
            };
            return colors[type] || "bg-gray-50";
        }

        function getTypeTextColor(type) {
            const colors = {
                scholarship: "text-blue-500",
                sme: "text-green-500",
                dental: "text-purple-500",
                age_verification: "text-orange-500",
                transaction: "text-pink-500",
            };
            return colors[type] || "text-gray-500";
        }

        function getStatusColor(status) {
            if (status === "approved") return "bg-green-50 dark:bg-green-900/20";
            if (status === "rejected") return "bg-red-50 dark:bg-red-900/20";
            return "bg-orange-50 dark:bg-orange-900/20";
        }

        function getStatusTextColor(status) {
            if (status === "approved") return "text-green-600";
            if (status === "rejected") return "text-red-600";
            return "text-orange-600";
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return "Just now";

            const now = Date.now();
            const time = new Date(timestamp).getTime();
            const diff = now - time;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return "Just now";
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return "Yesterday";
            return `${days} days ago`;
        }
    </script>
    <script src="google_translate.js"></script>
</body>

</html>