<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Profile - MyMULA</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d7ff2",
                        "accent": "#4CA9FF",
                        "background-light": "#F7F9FC",
                        "background-dark": "#0f1923",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        body {
            min-height: 100dvh;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div
        class="relative flex min-h-screen w-full flex-col bg-background-light dark:bg-background-dark overflow-x-hidden">

        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-accent p-6 pb-20">
            <h1 class="text-xl font-bold text-white mb-1">My Profile</h1>
            <p class="text-white/80 text-sm">Manage your verified documents</p>
        </div>

        <!-- Profile Card -->
        <div class="px-4 -mt-14">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-lg">
                <div class="flex items-center gap-4">
                    <div
                        class="h-16 w-16 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-2xl shadow-md">
                        A
                    </div>
                    <div class="flex-1">
                        <h2 class="text-lg font-bold text-[#333] dark:text-white">Sarah Tan</h2>
                        <p class="text-sm text-gray-500">IC: 850612-10-XXXX</p>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="material-symbols-outlined text-green-500 text-sm">verified</span>
                            <span class="text-xs text-green-600">Identity Verified</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verified Documents Section -->
        <div class="px-4 py-4">
            <h3 class="text-base font-bold text-[#333] dark:text-white mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-500">verified</span>
                Verified Documents
            </h3>

            <div class="flex flex-col gap-2" id="documentsList">
                <!-- Documents will be loaded here -->
            </div>
        </div>

        <!-- NEW: Linked Child Documents Section -->
        <div id="childDocsSection" class="hidden px-4 py-2 mb-4">
            <div class="bg-blue-50 dark:bg-blue-900/10 rounded-xl p-4 border border-blue-100 dark:border-blue-800">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold text-[#333] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-500">child_care</span>
                        Linked Child's Documents
                    </h3>
                    <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Ali Bin Abu</span>
                </div>

                <div class="flex flex-col gap-2" id="childDocsList">
                    <!-- Child Docs Loaded Here -->
                </div>
            </div>
        </div>

        <!-- Add Documents Section -->
        <div class="px-4 py-2">
            <h3 class="text-base font-bold text-[#333] dark:text-white mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">add_circle</span>
                Additional Documents
            </h3>

            <button onclick="showAddDocModal()"
                class="w-full flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border-2 border-dashed border-gray-300 dark:border-gray-600 hover:border-primary transition-colors">
                <div class="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary">upload_file</span>
                </div>
                <div class="flex-1 text-left">
                    <p class="text-base font-medium text-[#333] dark:text-white">Add More Documents</p>
                    <p class="text-sm text-gray-500">Upload additional verification documents</p>
                </div>
                <span class="material-symbols-outlined text-gray-400">add</span>
            </button>
        </div>

        <!-- Settings Section -->
        <div class="px-4 py-4 flex-1">
            <h3 class="text-base font-bold text-[#333] dark:text-white mb-3 flex items-center gap-2">
                <span class="material-symbols-outlined text-gray-500">settings</span>
                Settings
            </h3>

            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm cursor-pointer">
                    <span class="material-symbols-outlined text-gray-500">notifications</span>
                    <span class="flex-1 text-[#333] dark:text-white">Notifications</span>
                    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                </div>
                <div class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm cursor-pointer">
                    <span class="material-symbols-outlined text-gray-500">security</span>
                    <span class="flex-1 text-[#333] dark:text-white">Privacy & Security</span>
                    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                </div>
                <a href="ai_chatbox.html"
                    class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm cursor-pointer hover:bg-gray-50 transition-colors">
                    <span class="material-symbols-outlined text-gray-500">help</span>
                    <span class="flex-1 text-[#333] dark:text-white">Help & Support</span>
                    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                </a>
                <a href="digital_curfew.html"
                    class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm cursor-pointer hover:bg-gray-50 transition-colors">
                    <span class="material-symbols-outlined text-gray-500">timer</span>
                    <span class="flex-1 text-[#333] dark:text-white">Digital Curfew and Control</span>
                    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                </a>
            </div>

            <!-- Logout Button -->
            <button onclick="handleLogout()"
                class="w-full mt-6 flex items-center justify-center gap-2 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl p-4 font-bold hover:bg-red-100 transition-colors">
                <span class="material-symbols-outlined">logout</span>
                Log Out
            </button>
        </div>

        <!-- Bottom Navigation -->
        <div class="sticky bottom-0">
            <div
                class="flex h-[72px] justify-around border-t border-[#f0f2f5] bg-white/80 px-4 pb-3 pt-2 dark:border-gray-700 dark:bg-background-dark/80 backdrop-blur-lg">

                <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#6c757d] dark:text-gray-400 hover:text-primary transition-colors"
                    href="adult_home.html">
                    <div class="flex h-8 items-center justify-center">
                        <span class="material-symbols-outlined">home</span>
                    </div>
                    <p class="text-xs font-semibold">Home</p>
                </a>

                <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#6c757d] dark:text-gray-400 hover:text-primary transition-colors"
                    href="adult_requests.html">
                    <div class="flex h-8 items-center justify-center">
                        <span class="material-symbols-outlined">pending_actions</span>
                    </div>
                    <p class="text-xs font-semibold">Requests</p>
                </a>

                <a class="flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-primary"
                    href="adult_profile.html">
                    <div class="flex h-8 items-center justify-center">
                        <span class="material-symbols-outlined fill">account_circle</span>
                    </div>
                    <p class="text-primary text-xs font-semibold">Profile</p>
                </a>

            </div>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div id="addDocModal" class="fixed inset-0 bg-black/50 z-50 hidden items-end justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl w-full max-w-md p-6 animate-slide-up">
            <h3 class="text-lg font-bold text-[#333] dark:text-white mb-4">Add Document</h3>
            <div class="flex flex-col gap-3">
                <button onclick="addDocument('Education Certificate')"
                    class="flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    <span class="material-symbols-outlined text-primary">school</span>
                    <span class="text-[#333] dark:text-white font-medium">Education Certificate</span>
                </button>
                <button onclick="addDocument('Bank Statement')"
                    class="flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    <span class="material-symbols-outlined text-primary">account_balance</span>
                    <span class="text-[#333] dark:text-white font-medium">Bank Statement</span>
                </button>
                <button onclick="addDocument('Property Document')"
                    class="flex items-center gap-3 p-4 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    <span class="material-symbols-outlined text-primary">home</span>
                    <span class="text-[#333] dark:text-white font-medium">Property Document</span>
                </button>
            </div>
            <button onclick="closeAddDocModal()" class="w-full mt-4 py-3 text-gray-500 font-medium">Cancel</button>
        </div>
    </div>

    <script>
        const VERIFIED_DOCS = [
            { name: 'Identity Card (MyKad)', icon: 'badge', verified: true },
            { name: 'Birth Certificate', icon: 'article', verified: true },
            { name: 'Payslip / Income Statement', icon: 'payments', verified: true },
            { name: 'Income Tax (LHDN)', icon: 'receipt_long', verified: true },
            { name: 'Family Status Document', icon: 'family_restroom', verified: true }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadDocuments();
        });

        function loadDocuments() {
            const container = document.getElementById('documentsList');
            // We use the same storage technique as child profile for simplicity
            const additionalDocs = JSON.parse(localStorage.getItem('adult_additional_docs') || '[]');

            // Generate HTML for pre-verified fixed docs
            const verifiedHtml = VERIFIED_DOCS.map(doc => `
                <div class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                <div class="h-10 w-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                    <span class="material-symbols-outlined text-green-500">${doc.icon || 'description'}</span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-[#333] dark:text-white">${doc.name}</p>
                    <p class="text-xs text-green-500">Verified by Government</p>
                </div>
                <span class="material-symbols-outlined text-green-500">verified</span>
                </div>
            `).join('');

            // Generate HTML for user-added docs
            const customHtml = additionalDocs.map(doc => {
                const status = sessionStorage.getItem(`${doc.name}_status`);
                const isVerified = status === 'verified';
                const isWaiting = status === 'waiting';

                // Simulation: if waiting, auto-verify after 7 seconds for demo
                if (isWaiting) {
                    setTimeout(() => {
                        sessionStorage.setItem(`${doc.name}_status`, 'verified');
                        // Simple reload or DOM update could happen here, but we'll let user refresh for now
                        // or lazy update next time they visit
                        loadDocuments();
                    }, 7000);
                }

                // If not waiting and not verified, assume verified for legacy/pre-existing items
                // BUT for new items from scanning, we rely on sessionStorage status
                // We'll treat 'undefined' status as 'Verified' for legacy items stored in localStorage before this change
                const finalVerified = isVerified || (!isWaiting && !status);

                const statusText = isWaiting ? 'Pending Verification' : 'Verified';
                const statusColor = isWaiting ? 'text-orange-500' : 'text-green-500';
                const iconColor = isWaiting ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-500' : 'bg-green-100 dark:bg-green-900/30 text-green-500';
                const iconSymbol = isWaiting ? 'pending' : 'verified';

                return `
                    <div class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
                    <div class="h-10 w-10 rounded-full ${iconColor} flex items-center justify-center">
                        <span class="material-symbols-outlined">${doc.icon || 'description'}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-[#333] dark:text-white">${doc.name}</p>
                        <p class="text-xs ${statusColor}">${statusText}</p>
                    </div>
                    <span class="material-symbols-outlined ${statusColor}">${iconSymbol}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = verifiedHtml + customHtml;
        }

        function showAddDocModal() {
            document.getElementById('addDocModal').classList.remove('hidden');
            document.getElementById('addDocModal').classList.add('flex');
        }

        function closeAddDocModal() {
            document.getElementById('addDocModal').classList.add('hidden');
            document.getElementById('addDocModal').classList.remove('flex');
        }

        function addDocument(docName) {
            // Check if already added
            const docs = JSON.parse(localStorage.getItem('adult_additional_docs') || '[]');
            if (docs.find(d => d.name === docName)) {
                alert("Document already added!");
                return;
            }

            // Add to list first
            docs.push({ name: docName, icon: 'description' }); // Default verify status logic handled in load
            localStorage.setItem('adult_additional_docs', JSON.stringify(docs));

            closeAddDocModal();

            // Redirect to scan with Return URL
            const returnUrl = encodeURIComponent('adult_profile.html');
            window.location.href = `scan_document.html?type=custom&name=${encodeURIComponent(docName)}&return_url=${returnUrl}`;
        }

        // === LOGOUT FUNCTIONALITY ===
        function handleLogout() {
            if (confirm('Are you sure you want to log out?')) {
                // Preserve session data for Demo Flow
                window.location.href = 'index.html';
            }
        }

        // === CHILD DOCS LOGIC ===
        function loadChildDocuments() {
            // Check if connected
            const guardianStatus = sessionStorage.getItem('guardian_status');

            if (guardianStatus === 'verified') {
                const container = document.getElementById('childDocsList');
                const section = document.getElementById('childDocsSection');
                section.classList.remove('hidden');

                // Get keys
                // We include standard ones + dynamic ones
                let keys = JSON.parse(sessionStorage.getItem('db_child_doc_keys') || '[]');

                // Also check for Standard Docs explicitly if they exist in session but not in key list
                const standardKeys = ['spm', 'birth', 'coq'];
                standardKeys.forEach(k => {
                    if (sessionStorage.getItem(`${k}_status`) === 'verified' && !keys.includes(k)) {
                        keys.push(k);
                    }
                });

                if (keys.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 italic">No documents shared yet.</p>';
                    return;
                }

                container.innerHTML = keys.map(key => {
                    // Get nice name
                    let name = key;
                    if (name === 'spm') name = 'SPM Certificate';
                    if (name === 'birth') name = 'Birth Certificate';
                    if (name === 'coq') name = 'Co-Curriculum';

                    return `
                        <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                             <div class="flex items-center gap-3">
                                 <div class="h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                     <span class="material-symbols-outlined text-blue-500 text-sm">description</span>
                                 </div>
                                 <p class="text-sm font-medium text-[#333] dark:text-white">${decodeURIComponent(name)}</p>
                             </div>
                             <button onclick="viewChildDocument('${key}')" class="text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors">
                                 View
                             </button>
                        </div>
                     `;
                }).join('');
            }
        }

        window.viewChildDocument = function (key) {
            const dataStr = sessionStorage.getItem(`${key}_data`);
            // Fallback for standard docs if data not fully saved in key (should be fixed in scan logic now)
            // But let's handle if it's missing
            let data = dataStr ? JSON.parse(dataStr) : { status: 'Verified', note: 'Data extraction simulation' };

            const modal = document.getElementById('viewDocModal');
            const content = document.getElementById('viewDocContent');

            let html = '<div class="space-y-3">';
            Object.entries(data).forEach(([k, value]) => {
                const label = k.charAt(0).toUpperCase() + k.slice(1);
                html += `
                    <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2 last:border-0 last:pb-0">
                        <span class="text-gray-500 dark:text-gray-400 text-sm">${label}</span>
                        <span class="font-semibold text-gray-900 dark:text-white text-sm text-right">${value}</span>
                    </div>`;
            });
            html += '</div>';

            // Use existing modal or create new one? 
            // IMPORTANT: The existing modal in this file is "addDocModal". We need a "viewDocModal".
            // We'll rename the target here and add the HTML below.
            document.getElementById('viewDocTitle').innerText = key.toUpperCase();
            content.innerHTML = html;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeViewDocModal = function () {
            const modal = document.getElementById('viewDocModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Call load
        loadChildDocuments();
    </script>

    <!-- View Document Modal (Unique to Adult View) -->
    <div id="viewDocModal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all scale-100 flex flex-col">
            <div
                class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">child_care</span>
                    <span id="viewDocTitle">Document</span>
                </h3>
                <button onclick="closeViewDocModal()" class="text-gray-500 hover:text-gray-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6" id="viewDocContent"></div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-700">
                <button onclick="closeViewDocModal()"
                    class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200">Close</button>
            </div>
        </div>
    </div>
</body>

</html>