<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Scan Document - MyMULA Junior</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0054A6",
                        accent: "#4CA9FF",
                        "background-light": "#F7F9FC",
                        "background-dark": "#0f1923",
                    },
                    fontFamily: {
                        display: ["Public Sans", "sans-serif"],
                    },
                    borderRadius: {
                        lg: "12px",
                        xl: "16px",
                    },
                },
            },
        };
    </script>
    <style>
        @keyframes scan-line {
            0% {
                top: 0;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .scan-animation {
            animation: scan-line 2.5s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
        }

        .bounce-on-tap:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }
    </style>
</head>

<body
    class="font-display bg-background-light text-[#333333] dark:text-white dark:bg-background-dark min-h-screen flex flex-col">

    <!-- Header -->
    <div class="flex items-center p-4 bg-white dark:bg-gray-900 shadow-sm z-10">
        <a href="mainpage_profile.html"
            class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined notranslate">arrow_back</span>
        </a>
        <h1 class="flex-1 text-center text-lg font-bold" id="pageTitle">Scan Document</h1>
        <div class="w-10"></div>
    </div>

    <!-- Scanner Area -->
    <div id="cameraView" class="flex-1 relative bg-black flex flex-col items-center justify-center overflow-hidden">
        <!-- Camera Feed Placeholder -->
        <div class="absolute inset-0 bg-gray-900">
            <!-- Simulated Camera Noise/Grid -->
            <div class="w-full h-full opacity-20"
                style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
        </div>

        <!-- Guide Frame -->
        <div class="relative w-[300px] h-[420px] border-2 border-white/50 rounded-lg">
            <div
                class="absolute top-0 left-0 w-full h-0.5 bg-green-500 shadow-[0_0_15px_rgba(34,197,94,0.8)] scan-animation">
            </div>
            <!-- Corner Markers -->
            <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white -mt-1 -ml-1"></div>
            <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white -mt-1 -mr-1"></div>
            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white -mb-1 -ml-1"></div>
            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white -mb-1 -mr-1"></div>
        </div>

        <p class="absolute bottom-32 text-white/80 font-medium text-sm bg-black/40 px-4 py-1 rounded-full">Position
            document within frame</p>

        <!-- Capture Button -->
        <div class="absolute bottom-10 w-full flex justify-center">
            <button onclick="captureImage()"
                class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-transparent active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-white rounded-full"></div>
            </button>
        </div>
    </div>

    <!-- Results Modal (Hidden Initially) -->
    <div id="resultsModal" class="fixed inset-0 bg-background-light dark:bg-background-dark z-50 hidden flex-col">
        <div class="flex-1 p-6 flex flex-col items-center justify-center">
            <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-6">
                <span class="material-symbols-outlined notranslate text-green-500 !text-4xl">check_circle</span>
            </div>
            <h2 class="text-2xl font-bold mb-2">Scan Successful!</h2>
            <p class="text-gray-500 dark:text-gray-400 text-center mb-8">We've extracted the following details from your
                document.</p>

            <!-- Extracted Data Card -->
            <div class="w-full bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm space-y-3" id="extractedDataList">
                <!-- Data injected via JS -->
            </div>
        </div>

        <div class="p-6 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800">
            <button onclick="confirmSubmission()"
                class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg bounce-on-tap mb-3">
                Submit for Verification
            </button>
            <button onclick="retakeScan()" class="w-full bg-transparent text-gray-500 font-bold py-3 rounded-xl">
                Retake Scan
            </button>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay"
        class="fixed inset-0 bg-black/80 z-[60] hidden flex-col items-center justify-center text-white">
        <span class="material-symbols-outlined notranslate animate-spin !text-4xl mb-4 text-primary">progress_activity</span>
        <p class="font-bold text-lg">Analyzing Document...</p>
        <p class="text-sm opacity-70">Extracting data via AI</p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const docType = urlParams.get('type') || 'generic';
        const docName = urlParams.get('name');
        const returnUrl = urlParams.get('return_url') || 'mainpage_profile.html';

        // Update Title
        const titleMap = {
            'spm': 'Scan SPM Certificate',
            'coq': 'Scan Co-Curriculum',
            'birth': 'Scan Birth Certificate',
            'guardian': 'Scan Guardian Birth Certificate'
        };

        document.getElementById('pageTitle').innerText = (docName ? `Scan ${docName}` : (titleMap[docType] || 'Scan Document'));

        function captureImage() {
            // Show processing
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('processingOverlay').classList.add('flex');

            setTimeout(() => {
                showResults();
            }, 2000);
        }

        function showResults() {
            document.getElementById('processingOverlay').classList.add('hidden');
            document.getElementById('processingOverlay').classList.remove('flex');

            document.getElementById('cameraView').classList.add('hidden');
            document.getElementById('resultsModal').classList.remove('hidden');
            document.getElementById('resultsModal').classList.add('flex');

            generateMockData();
        }

        function generateMockData() {
            const container = document.getElementById('extractedDataList');
            container.innerHTML = getMockDataHtml();
        }

        function getMockDataHtml() {
            let html = '';
            if (docType === 'spm') {
                html = `
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Candidate Name</span>
                    <span class="font-semibold">Ali Bin Abu</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Year</span>
                    <span class="font-semibold">2023</span>
                </div>
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Subjects Detected</span>
                    <span class="font-semibold text-green-500">9 Subjects</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Overall Grade</span>
                    <span class="font-semibold">5A 2B 2C</span>
                </div>
            `;
            } else if (docType === 'coq') {
                html = `
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Activity</span>
                    <span class="font-semibold">Football Club</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Level</span>
                    <span class="font-semibold">District (MSSD)</span>
                </div>
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Achievement</span>
                    <span class="font-semibold">Runner-up</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Calculated Merit</span>
                    <span class="font-semibold text-green-500">15 Points</span>
                </div>
            `;
            } else if (docType === 'birth') {
                html = `
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Name</span>
                    <span class="font-semibold">Ali Bin Abu</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Child MyKid/IC</span>
                    <span class="font-semibold">******-**-1234</span>
                </div>
            `;
            } else if (docType === 'guardian') {
                html = `
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Child Name</span>
                    <span class="font-semibold">Ali Bin Abu</span>
                </div>
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Guardian Name</span>
                    <span class="font-semibold">Abu Bakar</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Guardian IC</span>
                    <span class="font-semibold">850214-10-5566</span>
                </div>
            `;
            } else if (docName === 'Car Licenses' || (docName && docName.toLowerCase().includes('license'))) {
                html = `
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Holder Name</span>
                    <span class="font-semibold">Ali Bin Abu</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Class</span>
                    <span class="font-semibold">D (Car)</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Expiry Date</span>
                    <span class="font-semibold text-green-500">12/12/2026</span>
                </div>
            `;
            } else if (docName === 'Passport Number' || (docName && docName.toLowerCase().includes('passport'))) {
                html = `
                 <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Country</span>
                    <span class="font-semibold">Malaysia</span>
                </div>
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Passport No</span>
                    <span class="font-semibold">A12345678</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Valid Until</span>
                    <span class="font-semibold text-green-500">10/05/2028</span>
                </div>
            `;
            } else {
                html = `
                <div class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2">
                    <span class="text-gray-500 dark:text-gray-400">Document Type</span>
                    <span class="font-semibold">${docName || docType || 'Document'}</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-gray-500 dark:text-gray-400">Status</span>
                    <span class="font-semibold text-green-500">Readable</span>
                </div>
            `;
            }
            return html;
        }

        function retakeScan() {
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('resultsModal').classList.remove('flex');
            document.getElementById('cameraView').classList.remove('hidden');
        }

        function confirmSubmission() {
            // Determine key to save. If custom name, use that as the key prefix.
            const storageKey = (docType === 'generic' || docType === 'custom') && typeof docName !== 'undefined' && docName ? docName : docType;

            // Generate full data object to save
            let dataToSave = {};
            if (docType === 'spm') {
                dataToSave = { candidate: "Ali Bin Abu", year: "2023", subjects: "9 Subjects", grade: "5A 2B 2C" };
            } else if (docType === 'coq') {
                dataToSave = { activity: "Football Club", level: "District (MSSD)", achievement: "Runner-up", merit: "15 Points" };
            } else if (docType === 'birth') {
                dataToSave = { name: "Ali Bin Abu", mykid: "******-**-1234", guardian_ic: "850214-10-5566", guardian_name: "Abu Bakar" };
            } else if (docType === 'guardian') {
                dataToSave = { child: "Ali Bin Abu", guardian: "Abu Bakar", ic: "850214-10-5566" };
            } else if (docName === 'Car Licenses') {
                dataToSave = { holder: "Ali Bin Abu", class: "D (Car)", expiry: "12/12/2026" };
            } else if (docName === 'Passport Number') {
                dataToSave = { country: "Malaysia", passport: "A12345678", valid: "10/05/2028" };
            } else {
                dataToSave = { type: docName || docType, status: "Readable" };
            }

            // Save key data for View functionality
            sessionStorage.setItem(`${storageKey}_data`, JSON.stringify(dataToSave));

            // Valid Adult IC for checking
            const validAdultIC = "850214-10-5566";

            // Special handling for guardian link or Birth Cert (which contains guardian info)
            if (docType === 'guardian' || docType === 'birth') {
                // Determine which IC to check
                const icToCheck = docType === 'guardian' ? dataToSave.ic : dataToSave.guardian_ic;

                if (icToCheck === validAdultIC) {
                    sessionStorage.setItem('guardian_status', 'verified'); // Auto-verify!

                    // If it was a birth cert scan, we should also construct the Guardian Data object for the profile
                    if (docType === 'birth') {
                        const guardianMock = { child: dataToSave.name, guardian: dataToSave.guardian_name, ic: dataToSave.guardian_ic, relation: "Father" };
                        sessionStorage.setItem('guardian_data', JSON.stringify(guardianMock));
                    } else {
                        sessionStorage.setItem('guardian_data', JSON.stringify(dataToSave));
                    }

                    if (docType === 'guardian') {
                        alert("Guardian Verified against Government Database!");
                    } else {
                        // For Birth Cert, we just implicitly verify guardian too
                        console.log("Guardian implicitly verified via Birth Cert.");
                    }
                } else if (docType === 'guardian') {
                    alert("Error: Guardian not found in Government Database or ID mismatch.");
                    return; // Stop submission
                }
            }

            if (docType !== 'guardian') {
                // Save state for all other types (including birth)
                sessionStorage.setItem(`${storageKey}_status`, 'verified');
                sessionStorage.setItem(`${storageKey}_timestamp`, new Date().toISOString());
            }

            // Add to central list of document keys for Adult View
            let docKeys = JSON.parse(sessionStorage.getItem('db_child_doc_keys') || '[]');
            if (!docKeys.includes(storageKey)) {
                docKeys.push(storageKey);
                sessionStorage.setItem('db_child_doc_keys', JSON.stringify(docKeys));
            }

            // --- SUMMARY LOGIC (Fixed formatting here) ---
            let summary = 'Details Extracted';
            if (docType === 'spm') {
                summary = '9 Subjects (5A 2B 2C)';
            } else if (docType === 'coq') {
                summary = 'Football Club (District)';
            } else if (docType === 'birth') {
                summary = 'Child MyKid/IC: 1234';
            } else if (docName === 'Car Licenses') {
                summary = 'Class D (Exp: 2026)';
            } else if (docName === 'Passport Number') {
                summary = 'MYS (Exp: 2028)';
            }

            if (docType !== 'guardian') {
                sessionStorage.setItem(`${storageKey}_summary`, summary);
            }

            // Redirect using the return URL
            console.log("Navigating to:", returnUrl);
            window.location.href = returnUrl;
        } 
    </script>
    <script src="google_translate.js"></script>
</body>

</html>